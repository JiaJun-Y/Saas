<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./common/css/reset.css">
  <link rel="stylesheet" href="./common/css/header.css">
  <link rel="stylesheet" href="./common/css/sideNav.css">
  <link rel="stylesheet" href="./common/css/app.css">

  <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="./common/header.js"></script>
  <script src="./common/sideNav.js"></script>
  <!-- <script src="./common/js/protocolcheck.js"></script> -->
  <script src="./common/js/lodash.min.js"></script>
  <script src="./common/js/utils.js"></script>
  <script src="./common/js/echarts.min.js"></script>
  <script src="./common/js/moment.min.js"></script>

  <!-- mockData need delete-->

  <title>首页</title>
</head>

<body>
  <!-- 顶部导航条 -->
  <div id="topNav">
    <div class='top-nav'>
      <!-- <div class='time'>
        <div class='img-box'>
          <img src='./images/calendar.png' />
        </div>
        <div id='time'></div>
      </div> -->
      <div class="header-box">
        <img src="./images/header-title.png" alt="">
      </div>
      <div class='user'>
        <div id='name'>连花清瘟胶囊</div>
        <div class='sub-title'>医生，欢迎使用分规心电</div>
        <span class='line'></span>
        <div class='img-box'>
          <img src='./images/quit.png' />
        </div>
      </div>
    </div>
  </div>

  <!-- <div class="order-wapper"> -->
  <!-- 侧边栏 -->
  <div id="sideNav">
    <div class='broadside-nav'>
      <ul>
        <!-- 已改 -->
        <li onclick='jump(this)' id='app'>
          <div class='img-box'>
            <div class="circle">0</div>
          </div>
          <p>主页</p>

        </li>
        <li onclick='jump(this)' id='book'>
          <div class='img-box'>
            <div class="circle">1</div>
          </div>
          <p>检查接待</p>

        </li>

        <li onclick='jump(this)' id="analysis">
          <div class='img-box'>
            <div class="circle">22</div>
          </div>
          <p>分析诊断</p>
        </li>

        <li onclick='jump(this)'>
          <div class='img-box'>
            <div class="circle">
              99+
            </div>
          </div>
          <p>更多功能</p>
        </li>

        <!-- <div id="newMessage">111</div> -->
        <!-- <audio src="./11.wav" muted autoplay id="myaudio" style="display: none"></audio> -->
      </ul>

      <div class='bottom-opt'>
        <div class='opt-left' onclick='help()'>
          <img src='./images/help.png' />
          <span>帮助</span>
        </div>

        <div class='opt-right' id="setting">
          <img src='./images/config.png' />
          <span>设置</span>
        </div>
      </div>
    </div>

    <!-- 帮助弹框 -->
    <div class='wx-code-wapper'>
      <div id='popLayer'></div>
      <div id='wx-code-box'>
        <div class='code-wapper'>
          <div class='title'>操作遇到问题？
            <span class='close' id='close'>
                  <img src='./images/guanbi.png' alt=''>
                </span>
          </div>
          <div class='wx-img-box'>
            <img src='./images/qr_gzh.png' alt=''>
          </div>
          <p>扫一扫</p>
          <p>关注分规心电公众号</p>
          <p>回复
            <span>“帮助”</span> 获取操作说明
          </p>
        </div>
      </div>
    </div>

    <!-- 设置tooltip -->
    <div class='config-wapper'>
      <div class='tooltip'>
        <p onclick='changeMsg()'>信息修改</p>
        <p onclick="downPlug()">插件下载</p>
        <!-- <p onclick="handleConfig()">预约设置</p> -->
        <span class='triangle'></span>
      </div>
    </div>

    <!-- 信息修改弹框 -->
    <div class='msg-wapper'>
      <div id='popLayer'></div>
      <div id='msg-pop'>
        <div class='title'>信息修改</div>
        <div class='msg-middle' id='msg-middle'>
          <div class='msg-input-box'>
            <span class='input-title'>姓名：</span>
            <input type='text' value='' name='name'>
          </div>

          <div class='msg-input-box'>
            <span class='input-title'>性别：</span>
            <select name='gender' value='0'>
                  <option value='male'>男</option>
                  <option value='female'>女</option>
                </select>
          </div>

          <div class='msg-input-box'>
            <span class='input-title'>旧密码：</span>
            <input type='password' placeholder='不修改密码则不填' value='' name="old-password">
          </div>

          <div class='msg-input-box'>
            <span class='input-title'>新密码：</span>
            <input type='password' placeholder='不修改密码则不填' value='' name="new-password">
          </div>

          <div class='msg-input-box'>
            <span class='input-title'>确认密码：</span>
            <input type='password' placeholder='不修改密码则不填' value='' name="comfire-password">
          </div>

        </div>
        <div class='msg-footer'>
          <div onclick='getPopMsg()'>确认</div>
          <div id='closeMsgPop'>取消</div>
        </div>
      </div>
    </div>

    <!-- 下载插件弹框 -->
    <div class='plugIn-wapper'>
      <div id='popLayer'></div>
      <div id='plugIn'>
        <div class='title'>插件下载</div>
        <div class='plug-content'>
          <span>院内采集端</span>
          <a href=''>下载</a>
        </div>
      </div>
    </div>
  </div>

  <!-- app.html内容开始 -->
  <div id="indexBox">
    <div class="top">
      <div class="top-left">
        <div class="time">
          <div id="time"></div>
        </div>

        <!-- 上左 -->
        <div class="dashboard">
          <div class="dashboard-left">
            <div class="analysis">今日分析：</div>
            <div class="workload">人均工作量：<span>25</span></div>
            <div class="crisis">危机值：<span>7</span></div>
            <div class="memorize">重背：<span>2</span></div>
            <div class="use">使用次数：<span>1789/5000</span></div>
          </div>
          <div class="dashboard-right">
            <div class="count" id="analysisNum">118</div>
            <div class="progress">
              <div class="progress-left"></div>
              <div class="progress-right">
                <div class="progress-item wear">
                  <strong id="wear" style="width:10%;"></strong>
                </div>
                <div class="progress-item import">
                  <strong id="import" style="width:100%;"></strong>
                </div>
                <div class="progress-item panalysis">
                  <strong id="panalysis" style="width:10%;"></strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 上右 -->
      <div class="top-right">
        <div class="title">本月数据日统计</div>
        <div class="statistical-charts">
          <div id="statisticalMain" style="height: 100%; width: 100%;"></div>
        </div>
      </div>
    </div>

    <!-- 表格 -->
    <div class="bottom">
      <div class="table-wapper">
        <div class="title">本周排班</div>
        <table class="table-inner-wapper">
          <tbody class="main-body"></tbody>
        </table>

        <div class="change-week">
          <img src="./images/table-date.png" alt="" class="table-date-img" onclick="currentWeek()">
          <img src="./images/be-week.png" alt="" class="table-date-img" id="beforWeek">
          <img src="./images/next-week.png" alt="" class="table-date-img" id="nextWeek">
          <img src="./images/table-p-config.png" alt="" class="table-date-img" onclick="goArrange()">
        </div>
      </div>
    </div>
  </div>


  <!-- app.html内容结束 -->
  <div class="index-bottom">
    <ul>
      <li><a href="">点击查看详情>></a></li>
      <li>版本号：build450.1.1</li>
      <li>升级提示：2019/07/09</li>
    </ul>
  </div>

  <!-- 设置弹框内容 -->
  <!-- <div class="config-pop-wapper">
    <div id="popLayer"></div>
    <div id="config-pop">
      <div class="title">设置</div>
      <div class="from-box">
        <p>设备数量上限<input type="text" id="count"></p>
        <div class="info">
          <div class="info-title">录入信息配置</div>
          <div class="info-input-box">
            <div class="info-input-format"><input type="checkbox" name="selectedRow" value="1" />申请单号</div>
            <div class="info-input-format"><input type="checkbox" name="selectedRow" value="2" />住院号</div>
            <div class="info-input-format"><input type="checkbox" name="selectedRow" value="3" />门诊号</div>
            <div class="info-input-format"><input type="checkbox" name="selectedRow" value="4" />病人ID</div>
            <div class="info-input-format"><input type="checkbox" name="selectedRow" value="5" />身份证号</div>
            <div class="info-input-format"><input type="checkbox" name="selectedRow" value="6" />手机号</div>
            <div class="info-input-format"><input type="checkbox" name="selectedRow" value="7" />住址</div>
          </div>
        </div>
        <div class="button-groups">
          <div class="comfire" onclick="handleConfigComfire()">确定</div>
          <div class="cancel" onclick="cancel()">取消</div>
        </div style="">
      </div>
    </div>
  </div> -->
</body>
<script>
  var AnalyticalDiagnosisPath = ''

  $("#popLayer").click(function(e) {
    $("#popLayer").hide();
    $('#config-pop').hide()
  })

  getPathUrl()
  getPanelData()
    // columnarCharts()
  lineCharts()
  currentDate() // 获取表格数据

  var Days = []
  var countNum = 0

  function getPathUrl() {
    $.get('http://192.199.198.73:8005/ryservice/load_ry_app_list?token=NhGLmIwVe1l5%2FsS3VzM0ANyaV%2FnGAOmowD9Ac%2FfcnKiznWUJD%2Fxh5HpnYuDXwqyOZjQEyG20KO%2F5JH4seZVyvLXJOblussBySOplc0QvX2moZsUf8sOhFX7TQE1glDCzEym1AmVK8pSbIzL%2Fiu8mTHcj5XU1ekZN%2F717viDWB80%3D', function(res) {
      console.log(res)
      if (!res) return
      var _appList = res.AppList
      var _Holter = []
      _Holter = _.filter(_appList, function(o) {
        return o.AppDescription === 'Holter'
      })

      if (_Holter.length > 0 && _Holter[0].URL.length > 0) {
        AnalyticalDiagnosisPath = _Holter[0].URL
        console.log(AnalyticalDiagnosisPath)
      } else {
        console.log('a')
      }
    })
  }

  // 表格数据处理
  function renderTable(tableData, Days) {
    // 7天的日期 + 空数据
    $('.table-inner-wapper .main-body').empty()

    for (var i = 0; i < Days.length; i++) {
      var tr = '<tr>'
      var td = '<td></td>'
      if (i > 0) {
        td = '<td>' + Days[i] + '\xa0' + '(' + DX(i) + ')' + '</td>'
      }

      if (tableData.Items.length === 0) {
        var emptyArr = new Array()
        emptyArr.unshift('ECG', '', '', '', '')
        for (var j = 0; j < emptyArr.length; j++) {
          if (i === 0) {
            td += '<td>' + emptyArr[j] + '</td>'
          } else {
            td += '<td></td>'
          }
        }
      } else {
        for (var j = 0; j < tableData.Items.length; j++) {
          if (i === 0) {
            td += '<td>' + tableData.Items[j] + '</td>'
          } else {
            var str = tableData.Mems[i - 1][j] ? tableData.Mems[i - 1][j] : ''
            td += '<td>' + str + '</td>'
          }
        }
      }

      tr += td
      tr += '</tr>'
      $('.table-inner-wapper .main-body').append(tr)
    }
  }

  // 获取当前日期
  function currentDate() {
    countNum = 0
    handleWeeks(countNum)
  }

  // 获取天数日期
  function handleWeeks(countNum) {
    Days = []
    var dateFrom = moment().subtract(countNum, "weeks").format("YYYY-MM-DD");
    var weekOfDay = moment(dateFrom).format('E')
    var last_monday = moment(dateFrom).subtract(weekOfDay - 1, 'days').format('YYYY-MM-DD')
    Days.push('')
    for (var i = 0; i < 7; i++) {
      Days.push(moment(last_monday).add(i, 'days').format('YYYY-MM-DD'))
    }

    getTableData(last_monday, Days)
  }

  // 当前一周
  function currentWeek() {
    countNum = 0
    handleWeeks(countNum)
  }

  // 获取前一周
  $('#beforWeek').on('click', throttle(function() {
    countNum++
    handleWeeks(countNum)
  }, 500))

  // 获取后一周
  $('#nextWeek').on('click', throttle(function() {
    countNum--
    handleWeeks(countNum)
  }, 500))

  // 调接口，获取表格数据
  function getTableData(monday, Days) {
    var params = {
      sDate: monday
    }
    $.post('http://192.199.198.22:8005/arrange/arrangeList', params, function(res) {
      if (!res) return
      renderTable(res, Days)
    })
  }

  // 折现统计图
  function lineCharts() {
    $.post('http://192.199.198.22:8005/book/examData', function(res) {
      if (!res) return
      var morkColumnar = res
      var statisticalChart = echarts.init(document.getElementById('statisticalMain'));
      option = {
        tooltip: {
          trigger: 'axis'
        },

        grid: {
          top: 10,
          right: 20,
          bottom: 20,
          left: 20,
          containLabel: true
        },

        xAxis: [{
          type: 'category',
          axisTick: {
            alignWithLabel: true
          },
          axisLine: {
            lineStyle: {
              color: '#888'
            }
          },
          data: morkColumnar.Data.days
        }],

        yAxis: [{
          type: 'value',
          min: 0,
          position: 'left',
          axisLine: {
            lineStyle: {
              color: '#888'
            }
          },
          splitLine: {
            lineStyle: {
              type: 'dashed'
            }
          }
        }],

        series: [{
          type: 'line',
          symbolSize: 8,
          itemStyle: {
            normal: {
              color: '#73b0e6', //改变折线点的颜色
              lineStyle: {
                color: '#73b0e6' //改变折线颜色
              }
            }
          },
          lineStyle: {
            normal: {
              width: 3,
              shadowColor: 'rgba(0,0,0,0.4)',
              shadowBlur: 10,
              shadowOffsetY: 10
            }
          },
          data: morkColumnar.Data.nums
        }]
      };

      statisticalChart.setOption(option);
    })

  }

  // 获取设置弹框信息
  // function handleConfigComfire() {
  //   $("input[name='selectedRow']:checked").each(function(index, item) {
  //     console.log($(this).val())
  //   });
  //   console.log($('#count').val())
  // }

  // // 关闭设置弹框
  // function cancel() {
  //   $('#popLayer').hide()
  //   $('#config-pop').hide()
  //   $('input:checkbox[name="selectedRow"]').removeAttr('checked');
  //   $('input').val('');
  // }

  function getPanelData() {
    $.post('http://192.199.198.22:8005/book/getPanelData', function(res) {
      if (!res) return
      var dashboardChartsData = res.Data
      var countAnalysis = Number(dashboardChartsData.Analysis.Finished + dashboardChartsData.Analysis.Unfinished)
      if (countAnalysis === 0) {
        $('#analysisNum').text('0000')
      } else {
        $('#analysisNum').text(countAnalysis)
      }
      columnarCharts(dashboardChartsData)
    })
  }

  function formattDataY(type, finished, unfinished) {
    var _value = ''
    if (finished === 0) {
      _value = '' + type + '（' + '0' + '%）'
    } else {
      _value = '' + type + '（' + ((finished / (finished + unfinished)) * 100) + '%）'
    }
    return _value
  }

  // 柱状图
  function columnarCharts(dashboardChartsData) {
    var _dataY = []
    var _dataX = []
    _.find(dashboardChartsData, function(val, key) {
      var _value = ''
      switch (key) {
        case 'Wear':
          _value = formattDataY('戴机', Number(val.Finished), Number(val.Unfinished))
          break;

        case 'Import':
          _value = formattDataY('录入', Number(val.Finished), Number(val.Unfinished))
          break;

        case 'Analysis':
          _value = formattDataY('分析', Number(val.Finished), Number(val.Unfinished))
          break
      }

      _dataY.push(_value)
      if (Number(val.Finished) === 0) {
        _dataX.push(0)
      } else {
        _dataX.push((Number(val.Finished) / (Number(val.Finished) + Number(val.Unfinished))))
      }
    })

    _.find(_dataY, function(val, index) {
      var _dom = '<div class="sign">' + val + '</div>'
      $('.progress-left').append(_dom)
    })

    _.find($('.progress-right strong'), function(child, _index) {
      $(child).css('width', _dataX[_index] * 100 + '%')
    })
  }

  function throttle(fn, delay) {
    let valid = true
    return function() {
      if (!valid) {
        return false
      }
      // 工作时间，执行函数并且在间隔期内把状态位设为无效
      valid = false
      setTimeout(function() {
        fn()
        valid = true;
      }, delay)
    }
  }
</script>

</html>